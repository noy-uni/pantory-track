{% extends "base.html" %}

{% block title %}åœ¨åº«ä¸€è¦§ - å–«èŒ¶åº—åœ¨åº«ç®¡ç†{% endblock %}

{% block content %}

<div class="p-chat-message">
  <div class="p-chat-message__icon">
    <img src="{{ url_for('static', filename='icons/chat-icon.png') }}" alt="ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼">
  </div>
  <div class="p-chat-message__bubble">
    <h1 class="text-2xl font-bold text-amber-900">ã“ã¡ã‚‰ãŒç¾åœ¨ã®åœ¨åº«ä¸€è¦§ã§ã™ã€‚</h1>
  </div>
</div>

<div class="input-card mb-8 !p-6 border-l-8 border-amber-400">
  <div class="space-y-6">
    <div>
      <input type="text" id="searchInput" placeholder="å•†å“åã§æ¤œç´¢..." class="input-field !py-2 text-base">
    </div>

    <div class="flex flex-wrap gap-2">
      <select id="statusFilter" class="input-field !mt-0 !py-2 text-base flex-1 min-w-[120px]">
        <option value="all">ã™ã¹ã¦ã®çŠ¶æ…‹</option>
        <option value="low">è£œå……ãŒå¿…è¦</option>
        <option value="out">åœ¨åº«åˆ‡ã‚Œ</option>
      </select>

      <select id="categoryFilter" class="input-field !mt-0 !py-2 text-base flex-1 min-w-[120px]">
        <option value="all">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
        {% for cat in categories %}
          <option value="{{ cat['id'] }}">{{ cat['name'] }}</option>
        {% endfor %}
      </select>

      <select id="sortOrder" class="input-field !mt-0 !py-2 text-base flex-1 min-w-[120px]">
        <option value="default">ç™»éŒ²é †</option>
        <option value="stock-asc">åœ¨åº«ã®å°‘ãªã„é †</option>
      </select>
    </div>
  </div>
</div>

<div id="productContainer" class="w-full space-y-4">
  {% for p in products %}
    {% set is_out = p['current_stock'] <= 0 %}
    {% set is_low = p['current_stock'] > 0 and p['current_stock'] <= p['reorder_level'] %}
    
    <div class="input-card product-item {% if is_out %}bg-rose-200 border-rose-500{% elif is_low %}bg-rose-100 border-rose-300{% endif %}"
         data-name="{{ p['name'] }}"
         data-stock="{{ p['current_stock'] }}"
         data-category="{{ p['category_id'] }}"
         data-status="{% if is_out %}out{% elif is_low %}low{% else %}ok{% endif %}">
      
      <div class="flex gap-5">
        <div class="w-24 h-24 rounded-2xl overflow-hidden flex-shrink-0 bg-slate-100 border-2 border-slate-200">
          {% if p['image_path'] %}
            <img src="{{ url_for('static', filename='products/' + p['image_path']) }}" alt="{{ p['name'] }}" class="w-full h-full object-cover">
          {% else %}
            <div class="w-full h-full flex items-center justify-center text-4xl">
              {% if 'ã‚³ãƒ¼ãƒ’ãƒ¼' in p['name'] %}â˜•
              {% elif 'ç‰›ä¹³' in p['name'] or 'ãƒŸãƒ«ã‚¯' in p['name'] %}ğŸ¥›
              {% elif 'ã‚¯ãƒªãƒ¼ãƒ ' in p['name'] %}ğŸ¶
              {% elif 'ç ‚ç³–' in p['name'] %}ğŸ§‚
              {% elif 'è±†' in p['name'] %}ğŸ«˜
              {% elif 'ãƒãƒ§ã‚³' in p['name'] %}ğŸ«
              {% elif 'èŒ¶' in p['name'] %}ğŸµ
              {% else %}ğŸ“¦
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="flex-1">
          <div class="mb-3">
            <h3 class="text-2xl font-bold text-slate-900">{{ p['name'] }}</h3>
            {% if p['origin'] %}<p class="text-base text-slate-500 mt-1">ç”£åœ°: {{ p['origin'] }}</p>{% endif %}
          </div>

          <div class="flex items-baseline gap-3 border-t border-slate-500 pt-2 pl-4">
            <div>
              <span class="text-3xl font-bold text-slate-900">{{ p['current_stock'] }}</span>
              <span class="text-lg text-slate-600 ml-1">{{ p['unit'] }}</span>
            </div>
            {% if is_out %}
            <span class="stock-status stock-status--danger">
              åœ¨åº«åˆ‡ã‚Œ
            </span>
          {% elif is_low %}
            <span class="stock-status stock-status--warning">
              è£œå……ãŒå¿…è¦
            </span>
          {% else %}
            <span class="stock-status stock-status--ok">
              åœ¨åº«ã‚ã‚Š
            </span>
          {% endif %}
          </div>
          <p class="text-base text-slate-500 mt-2 pl-4">ç™ºæ³¨ç‚¹: {{ p['reorder_level'] }} {{ p['unit'] }}</p>
        </div>
      </div>
    </div>
  {% else %}
    <div class="input-card text-center py-8">
      <div class="text-5xl mb-4">ğŸ“­</div>
      <p class="text-lg text-slate-500">ã¾ã å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    </div>
  {% endfor %}
</div>

<div class="bg-blue-50 border-2 border-blue-200 rounded-2xl px-5 py-4 mt-6">
  <p class="text-sm text-blue-900">ğŸ’¡ <strong>å…¥åº«ãƒ»å‡ºåº«ä½œæ¥­</strong>ã‚’ã™ã‚‹å ´åˆã¯ã€ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰å„ãƒœã‚¿ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
</div>

<div class="c-footer-nav w-full flex flex-col gap-4 mt-10">
  <a href="{{ url_for('index') }}" class="btn-footer-sub">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const categoryFilter = document.getElementById('categoryFilter');
  const sortOrder = document.getElementById('sortOrder');
  const container = document.getElementById('productContainer');

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã€Œåœ¨åº«ã®å°‘ãªã„é †ã€ã«å¤‰æ›´ã—ã¾ã™ã‚
  sortOrder.value = 'stock-asc';

  function updateList() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const categoryValue = categoryFilter.value;
    const sortValue = sortOrder.value;
    
    let items = Array.from(document.querySelectorAll('.product-item'));
    
    // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    items.forEach(item => {
      const name = item.dataset.name.toLowerCase();
      const status = item.dataset.status;
      const category = item.dataset.category;
      
      const matchesSearch = name.includes(searchTerm);
      const matchesStatus = statusValue === 'all' || status === statusValue;
      const matchesCategory = categoryValue === 'all' || category === categoryValue;
      
      item.style.display = (matchesSearch && matchesStatus && matchesCategory) ? 'block' : 'none';
    });

    // 2. ä¸¦ã³æ›¿ãˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚‚ã“ã“ã‚’é€šã‚‹ã‚ˆã†ã«ã„ãŸã—ã¾ã™ï¼‰
    if (sortValue === 'stock-asc') {
      items.sort((a, b) => parseFloat(a.dataset.stock) - parseFloat(b.dataset.stock));
    } else {
      // ç™»éŒ²é †ï¼ˆå…ƒã®HTMLä¸Šã®é †åºï¼‰ã‚’ç¶­æŒã—ãŸã„å ´åˆãªã©ã¯ã€ã“ã“ã§åˆ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‰ã‚Œã¾ã™ã‚
    }
    
    // ã‚½ãƒ¼ãƒˆçµæœã‚’åæ˜ 
    items.forEach(item => container.appendChild(item));
  }

  // åˆå›è¡¨ç¤ºæ™‚ã«ä¸€åº¦å®Ÿè¡Œã—ã¦ã€åˆæœŸçŠ¶æ…‹ã§ä¸¦ã³æ›¿ãˆã¾ã™ã‚
  updateList();

  searchInput.addEventListener('input', updateList);
  statusFilter.addEventListener('change', updateList);
  categoryFilter.addEventListener('change', updateList);
  sortOrder.addEventListener('change', updateList);
});
</script>
{% endblock %}

{% endblock %}